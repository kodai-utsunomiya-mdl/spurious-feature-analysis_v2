wandb is enabled and initialized.
Results will be saved to: results/wb_cnn_gradient_basis_2025-10-28_08-42-17
Using device: cuda

--- 1. Preparing Dataset ---

Displaying and saving 10 sample images from the WaterBirds train set...
Sample images saved to results/wb_cnn_gradient_basis_2025-10-28_08-42-17/dataset_samples.png

--- SCC-GF (Debias Method) Enabled ---
  [Warning] 'batch_size' config is ignored. Using full-batch (per-group) gradient calculation.
  Calculated statistics and weights:
  E[Y] (y_bar) = -0.5358
  E[A] (a_bar) = -0.4824
  w_g(-1.0, -1.0) = 0.569146
  w_g(-1.0, 1.0) = 0.198737
  w_g(1.0, -1.0) = 0.172042
  w_g(1.0, 1.0) = 0.060074

--- Train Set Group Distribution (WaterBirds) ---
Waterbird on Water (y=+1, a=+1)    :  1057 samples
Waterbird on Land (y=+1, a=-1)     :    56 samples
Landbird on Water (y=-1, a=+1)     :   184 samples
Landbird on Land (y=-1, a=-1)      :  3498 samples
Total                              :  4795 samples


--- Test Set Group Distribution (WaterBirds) ---
Waterbird on Water (y=+1, a=+1)    :   642 samples
Waterbird on Land (y=+1, a=-1)     :   642 samples
Landbird on Water (y=-1, a=+1)     :  2255 samples
Landbird on Land (y=-1, a=-1)      :  2255 samples
Total                              :  5794 samples


--- 2. Setting up Model and Optimizer ---
Using ResNet18Classifier model for WaterBirds.

Using standard optimizer setup (no manual parametrization).

--- 3. Starting Training & Evaluation Loop ---
Epoch     1/20000 | Train [Loss: 122.0994, Worst: 158.5431, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 121.9571, Worst: 159.1549, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 1 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 1 ===========================

Epoch     2/20000 | Train [Loss: 5510389062349786251048949645312.0000, Worst: 5642680605864395507007871778816.0000, Acc: 0.2321, Worst: 0.0000] | Test [Loss: 5418597138255176879757271760896.0000, Worst: 5652630065359823905115703607296.0000, Acc: 0.2216, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 2 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...
/home/utsu/sp_v2/analysis.py:598: RuntimeWarning: overflow encountered in dot
  weighted_dot_product += lr * np.dot(grad1_p, grad2_p)
/home/utsu/sp_v2/analysis.py:598: RuntimeWarning: invalid value encountered in dot
  weighted_dot_product += lr * np.dot(grad1_p, grad2_p)

Analyzing GRADIENT BASIS VECTORS on Train data...
/home/utsu/sp_v2/analysis.py:626: RuntimeWarning: overflow encountered in dot
  dot_product += lr * np.dot(v1_p, v2_p)
/home/utsu/sp_v2/analysis.py:626: RuntimeWarning: invalid value encountered in dot
  dot_product += lr * np.dot(v1_p, v2_p)

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 2 ===========================

Epoch     3/20000 | Train [Loss: nan, Worst: 0.0000, Acc: 0.0000, Worst: 0.0000] | Test [Loss: nan, Worst: 0.0000, Acc: 0.0000, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 3 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...
/home/utsu/sp_v2/analysis.py:659: RuntimeWarning: invalid value encountered in add
  v_A[i]   += a * grads_p_list[i]
/home/utsu/sp_v2/analysis.py:660: RuntimeWarning: invalid value encountered in add
  v_AY[i]  += (y * a) * grads_p_list[i]
/home/utsu/sp_v2/analysis.py:658: RuntimeWarning: invalid value encountered in add
  v_C[i]   += y * grads_p_list[i]

Analyzing PROPOSITION 1 TERMS on Train data...
/home/utsu/sp_v2/analysis.py:745: RuntimeWarning: invalid value encountered in subtract
  delta_nabla_21 = [g2 - g1 for g1, g2 in zip(grad_g1, grad_g2)]
========================= END OF ANALYSIS @ EPOCH 3 ===========================
Traceback (most recent call last):
  File "/home/utsu/sp_v2/main.py", line 801, in <module>
    main(config_path='config.yaml')
  File "/home/utsu/sp_v2/main.py", line 634, in main
    X_mb, y_mb = X_mb.to(device), y_mb.to(device)
                 ^^^^^^^^^^^^^^^
KeyboardInterrupt
