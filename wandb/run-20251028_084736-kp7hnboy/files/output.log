wandb is enabled and initialized.
Results will be saved to: results/wb_cnn_gradient_basis_2025-10-28_08-47-37
Using device: cuda

--- 1. Preparing Dataset ---

Displaying and saving 10 sample images from the WaterBirds train set...
Sample images saved to results/wb_cnn_gradient_basis_2025-10-28_08-47-37/dataset_samples.png

--- SCC-GF (Debias Method) Enabled ---
  [Warning] 'batch_size' config is ignored. Using full-batch (per-group) gradient calculation.
  Calculated statistics and weights:
  E[Y] (y_bar) = -0.5358
  E[A] (a_bar) = -0.4824
  w_g(-1.0, -1.0) = 0.569146
  w_g(-1.0, 1.0) = 0.198737
  w_g(1.0, -1.0) = 0.172042
  w_g(1.0, 1.0) = 0.060074

--- Train Set Group Distribution (WaterBirds) ---
Waterbird on Water (y=+1, a=+1)    :  1057 samples
Waterbird on Land (y=+1, a=-1)     :    56 samples
Landbird on Water (y=-1, a=+1)     :   184 samples
Landbird on Land (y=-1, a=-1)      :  3498 samples
Total                              :  4795 samples


--- Test Set Group Distribution (WaterBirds) ---
Waterbird on Water (y=+1, a=+1)    :   642 samples
Waterbird on Land (y=+1, a=-1)     :   642 samples
Landbird on Water (y=-1, a=+1)     :  2255 samples
Landbird on Land (y=-1, a=-1)      :  2255 samples
Total                              :  5794 samples


--- 2. Setting up Model and Optimizer ---
Using ResNet18Classifier model for WaterBirds.

Using standard optimizer setup (no manual parametrization).

--- 3. Starting Training & Evaluation Loop ---
Epoch     1/20000 | Train [Loss: 0.7975, Worst: 1.8562, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7448, Worst: 1.8508, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 1 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 1 ===========================

Epoch     2/20000 | Train [Loss: 0.6878, Worst: 3.3968, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7889, Worst: 3.3235, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 2 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 2 ===========================

Epoch     3/20000 | Train [Loss: 0.7309, Worst: 3.7251, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.8125, Worst: 3.6513, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 3 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 3 ===========================

Epoch     4/20000 | Train [Loss: 0.6914, Worst: 3.0421, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7325, Worst: 3.0111, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 4 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 4 ===========================

Epoch     5/20000 | Train [Loss: 0.7614, Worst: 2.1243, Acc: 0.7625, Worst: 0.0000] | Test [Loss: 0.7172, Worst: 2.1079, Acc: 0.7763, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 5 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 5 ===========================

Epoch     6/20000 | Train [Loss: 0.9736, Worst: 1.8314, Acc: 0.6482, Worst: 0.0255] | Test [Loss: 0.8225, Worst: 1.8000, Acc: 0.7220, Worst: 0.0343]

========================= CHECKPOINT ANALYSIS @ EPOCH 6 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 6 ===========================

Epoch     7/20000 | Train [Loss: 1.0563, Worst: 1.8688, Acc: 0.6063, Worst: 0.0378] | Test [Loss: 0.8575, Worst: 1.8320, Acc: 0.6997, Worst: 0.0561]

========================= CHECKPOINT ANALYSIS @ EPOCH 7 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 7 ===========================

Epoch     8/20000 | Train [Loss: 0.9318, Worst: 2.2249, Acc: 0.6870, Worst: 0.0123] | Test [Loss: 0.7704, Worst: 2.1885, Acc: 0.7428, Worst: 0.0218]

========================= CHECKPOINT ANALYSIS @ EPOCH 8 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 8 ===========================

Epoch     9/20000 | Train [Loss: 0.8110, Worst: 2.7267, Acc: 0.7564, Worst: 0.0000] | Test [Loss: 0.7151, Worst: 2.6954, Acc: 0.7742, Worst: 0.0016]

========================= CHECKPOINT ANALYSIS @ EPOCH 9 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 9 ===========================

Epoch    10/20000 | Train [Loss: 0.7846, Worst: 3.0567, Acc: 0.7673, Worst: 0.0000] | Test [Loss: 0.7305, Worst: 3.0331, Acc: 0.7779, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 10 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 10 ===========================

Epoch    11/20000 | Train [Loss: 0.7680, Worst: 2.9927, Acc: 0.7675, Worst: 0.0000] | Test [Loss: 0.7264, Worst: 2.9709, Acc: 0.7779, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 11 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 11 ===========================

Epoch    12/20000 | Train [Loss: 0.7530, Worst: 2.6327, Acc: 0.7660, Worst: 0.0000] | Test [Loss: 0.7035, Worst: 2.6074, Acc: 0.7772, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 12 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 12 ===========================

Epoch    13/20000 | Train [Loss: 0.7693, Worst: 2.2649, Acc: 0.7600, Worst: 0.0000] | Test [Loss: 0.7103, Worst: 2.2378, Acc: 0.7744, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 13 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 13 ===========================

Epoch    14/20000 | Train [Loss: 0.7615, Worst: 2.1044, Acc: 0.7610, Worst: 0.0000] | Test [Loss: 0.7174, Worst: 2.0803, Acc: 0.7746, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 14 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 14 ===========================

Epoch    15/20000 | Train [Loss: 0.7074, Worst: 2.2760, Acc: 0.7675, Worst: 0.0000] | Test [Loss: 0.7046, Worst: 2.2995, Acc: 0.7779, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 15 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 15 ===========================

Epoch    16/20000 | Train [Loss: 0.6769, Worst: 2.8047, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7146, Worst: 2.8036, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 16 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 16 ===========================

Epoch    17/20000 | Train [Loss: 0.6880, Worst: 3.2220, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7467, Worst: 3.2032, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 17 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 17 ===========================

Epoch    18/20000 | Train [Loss: 0.6863, Worst: 3.2139, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7476, Worst: 3.1976, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 18 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 18 ===========================

Epoch    19/20000 | Train [Loss: 0.6708, Worst: 2.7958, Acc: 0.7679, Worst: 0.0000] | Test [Loss: 0.7182, Worst: 2.7959, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 19 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 19 ===========================

Epoch    20/20000 | Train [Loss: 0.6883, Worst: 2.3076, Acc: 0.7677, Worst: 0.0000] | Test [Loss: 0.7090, Worst: 2.3274, Acc: 0.7784, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 20 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 20 ===========================

Epoch    21/20000 | Train [Loss: 0.7250, Worst: 2.0358, Acc: 0.7662, Worst: 0.0000] | Test [Loss: 0.7179, Worst: 2.0722, Acc: 0.7774, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 21 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 21 ===========================

Epoch    22/20000 | Train [Loss: 0.7327, Worst: 2.0880, Acc: 0.7650, Worst: 0.0000] | Test [Loss: 0.7125, Worst: 2.1065, Acc: 0.7763, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 22 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 22 ===========================

Epoch    23/20000 | Train [Loss: 0.7181, Worst: 2.3066, Acc: 0.7664, Worst: 0.0000] | Test [Loss: 0.7008, Worst: 2.3533, Acc: 0.7777, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 23 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 23 ===========================

Epoch    24/20000 | Train [Loss: 0.7150, Worst: 2.5540, Acc: 0.7675, Worst: 0.0000] | Test [Loss: 0.7011, Worst: 2.6073, Acc: 0.7779, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 24 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 24 ===========================

Epoch    25/20000 | Train [Loss: 0.7245, Worst: 2.6171, Acc: 0.7675, Worst: 0.0000] | Test [Loss: 0.7032, Worst: 2.6679, Acc: 0.7779, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 25 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 25 ===========================

Epoch    26/20000 | Train [Loss: 0.7358, Worst: 2.5437, Acc: 0.7664, Worst: 0.0000] | Test [Loss: 0.7003, Worst: 2.5242, Acc: 0.7774, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 26 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 26 ===========================

Epoch    27/20000 | Train [Loss: 0.7569, Worst: 2.4017, Acc: 0.7604, Worst: 0.0000] | Test [Loss: 0.7036, Worst: 2.3782, Acc: 0.7751, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 27 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 27 ===========================

Epoch    28/20000 | Train [Loss: 0.7742, Worst: 2.3079, Acc: 0.7556, Worst: 0.0028] | Test [Loss: 0.7098, Worst: 2.2836, Acc: 0.7732, Worst: 0.0016]

========================= CHECKPOINT ANALYSIS @ EPOCH 28 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...

Analyzing GRADIENT BASIS VECTORS on Train data...

Analyzing PROPOSITION 1 TERMS on Train data...
========================= END OF ANALYSIS @ EPOCH 28 ===========================

Epoch    29/20000 | Train [Loss: 0.7647, Worst: 2.3349, Acc: 0.7583, Worst: 0.0019] | Test [Loss: 0.7068, Worst: 2.3113, Acc: 0.7739, Worst: 0.0000]

========================= CHECKPOINT ANALYSIS @ EPOCH 29 =========================

Analyzing GRADIENT GRAM MATRIX on Train data...
Traceback (most recent call last):
  File "/home/utsu/sp_v2/main.py", line 801, in <module>
    main(config_path='config.yaml')
  File "/home/utsu/sp_v2/main.py", line 754, in main
    analysis.run_all_analyses(
  File "/home/utsu/sp_v2/analysis.py", line 935, in run_all_analyses
    grad_gram_train_results, group_grads_train = analyze_gradient_gram_matrix(
                                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/utsu/sp_v2/analysis.py", line 560, in analyze_gradient_gram_matrix
    X_mini, y_mini = X_mini.to(device), y_mini.to(device)
                     ^^^^^^^^^^^^^^^^^
KeyboardInterrupt
