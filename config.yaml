# sp/config.yaml

# ---------------------------------
# 実験の基本設定
# ---------------------------------
experiment_name: "wb_gradient_basis"
dataset_name: "WaterBirds"  # "ColoredMNIST" or "WaterBirds"
loss_function: "mse"          # "logistic" or "mse"
activation_function: "relu"   # 'relu', 'gelu', 'tanh', 'identity', 'silu', 'softplus'
initialization_method: "mf"  # "SP", "NTP", "muP", "mf", "NTP_two_layer" (mfおよびNTP_two_layerは隠れ層1つのときのみ有効)
use_skip_connections: false
device: "cuda"                # "cuda" or "cpu"

# ---------------------------------
# データセット設定
# ---------------------------------
num_train_samples: 50000
num_test_samples: 9000

# --- 事前特徴抽出器の設定 ---
use_feature_extractor: true

# --- 特徴抽出器のモデル選択 ---
# 'ResNet18', 'ResNet50', 'ViT_B_16'
# DINOv2系: 'DINOv2_ViT_S_14' (384-dim), 'DINOv2_ViT_B_14' (768-dim),
#            'DINOv2_ViT_L_14' (1024-dim), 'DINOv2_ViT_G_14' (1536-dim)
feature_extractor_model_name: "DINOv2_ViT_G_14" 

# --- ResNet系 中間層特徴マップ設定 ---
# [ResNet系 ('ResNet18', 'ResNet50') でのみ有効]
# 'avgpool': avgpool 後のベクトル (デフォルト)
# 'layer3': ResNetの layer3 出力
# 'layer4': ResNetの layer4 出力
feature_extractor_resnet_intermediate_layer: "avgpool" 

# 'resnet_intermediate_layer' が 'avgpool' 以外の場合の適応的空間プーリングサイズ
# 1 -> (1x1), 2 -> (2x2), 3 -> (3x3)
feature_extractor_resnet_pooling_output_size: 2 

# --- ViT/DINOv2系 中間層設定 ---
# [ViT/DINOv2系でのみ有効]
# 抽出するブロックのインデックス (0 から N-1). 
# -1 は最後のブロック, -2 は最後から2番目, ...
# (ViT_B_16: 12 blocks (0-11))
# (DINOv2_ViT_S_14, DINOv2_ViT_B_14: 12 blocks (0-11))
# (DINOv2_ViT_L_14: 24 blocks (0-23))
# (DINOv2_ViT_G_14: 40 blocks (0-39))
feature_extractor_vit_target_block: -1 # デフォルトは最後のブロック

# 'target_block' からの特徴をどう集約するか
# 'cls_token': [CLS] トークンのみを使用 (デフォルト)
# 'mean_pool_patch': パッチトークンのみを平均プーリング
# 'mean_pool_all': [CLS] と パッチトークンの両方を平均プーリング
feature_extractor_vit_aggregation_mode: "mean_pool_all" 


# --- ColoredMNIST 特有の設定 ---
train_correlation: 0.8
train_label_marginal: 0.0       # E[Y] (ラベル不均衡度: -1.0 ~ 1.0)
train_attribute_marginal: 0.0   # E[A] (属性不均衡度: -1.0 ~ 1.0)
test_correlation: 0.0
test_label_marginal: 0.0        # E[Y] (テストセット)
test_attribute_marginal: 0.0    # E[A] (テストセット)

# ---------------------------------
# モデル設定
# ---------------------------------
num_hidden_layers: 1
hidden_dim: 4096

# ---------------------------------
# 学習設定
# ---------------------------------
epochs: 20000
train_batch_size: 50000   # ERMの場合の学習バッチサイズ (IW や DRO では無視する)
eval_batch_size: 50000    # 評価時のバッチサイズ
optimizer: "SGD"    # "SGD" or "Adam"
learning_rate: 0.1
momentum: 0.0
fix_final_layer: false  # trueにすると最終層の重みを固定

# --- バイアス除去手法の選択 ---
debias_method: "None" # "None" (ERM), "IW_uniform", "GroupDRO" から選択

# --- Group DRO Settings ---
dro_eta_q: 0.01 # グループ重みqを更新するためのステップサイズ (学習率)

# ------------------------------------------
# 解析・可視化設定
# ------------------------------------------
# 各種分析の実行エポック設定 (キー自体を省略 or 値を空(None) -> 毎エポック, 空リスト[] -> 無効化)
gradient_gram_analysis_epochs:
gradient_gram_spectrum_analysis_epochs:
gradient_norm_ratio_analysis_epochs:
gradient_basis_analysis_epochs:
proposition1_terms_analysis_epochs:
jacobian_norm_analysis_epochs:

# 命題1の分析設定
proposition1_terms:
  # 分析対象とするグループペア [g1, g2] のリスト
  group_pairs:
    - [[-1, 1], [-1, -1]]  # 少数派・多数派
    - [[1, -1], [-1, -1]]
    - [[ 1,  -1], [ 1, 1]]

# 勾配ノルム比の分析設定
gradient_norm_ratio_config:
  # 分析対象とするグループペア [g_numerator, g_denominator] のリスト
  group_pairs:
    - [[-1, -1], [-1, 1]]  # 多数派(y=-1) / 少数派(y=-1)
    - [[ 1,  1], [ 1, -1]]  # 多数派(y= 1) / 少数派(y= 1)

# 解析対象データセット ('train', 'test', 'both')
analysis_target: 'train'
jacobian_num_samples: 100    # ヤコビアンを計算するためのグループから使用するサンプル数
gradient_gram_num_samples: null # 勾配グラム行列を計算するためのグループから使用するサンプル数 (null の場合は全サンプル使用)
show_and_save_samples: true  # 実行時にデータセットのサンプル画像を表示・保存するか

# ---------------------------------
# 解析の有効/無効フラグ
# ---------------------------------
analyze_gradient_gram: false
analyze_jacobian_norm: true
analyze_gradient_gram_spectrum: false
analyze_gradient_norm_ratio: false
analyze_gradient_basis: true
analyze_proposition1_terms: true

# ---------------------------------
# wandb設定
# ---------------------------------
wandb:
  enable: true
  project: "sp_exp_gram_basis"
  entity: "mdl-tsukuba"
